<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Cloud Phone Free</title>
  <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <style>
    body {
      margin:0; font-family:Segoe UI, sans-serif; background:#0f172a; color:white;
      display:flex; height:100vh; justify-content:center; align-items:center;
    }
    .app {
      width:90%; max-width:1200px; height:90%; display:flex; gap:16px;
    }
    .videoArea {
      flex:3; background:#000; border-radius:16px; overflow:hidden;
      display:flex; justify-content:center; align-items:center;
      position:relative;
    }
    video { width:100%; height:100%; object-fit:cover; }
    .sidebar {
      flex:1; background:#1e293b; border-radius:16px; padding:16px; display:flex; flex-direction:column;
    }
    .roomBox { margin-bottom:16px; }
    input, button {
      padding:10px; border:none; border-radius:8px; font-size:14px;
    }
    input { flex:1; }
    button {
      background:linear-gradient(135deg,#3b82f6,#06b6d4);
      color:white; cursor:pointer; font-weight:600; transition:.2s;
    }
    button:hover { opacity:.85; }
    .chatBox {
      flex:1; background:#0f172a; border-radius:12px; padding:10px; overflow-y:auto; margin:10px 0;
    }
    .msg { margin:4px 0; }
    .me { color:#3b82f6; }
    .peer { color:#06b6d4; }
    .controls { display:flex; gap:8px; }
  </style>
</head>
<body>
<div class="app">
  <div class="videoArea">
    <video id="remoteVideo" autoplay playsinline></video>
  </div>
  <div class="sidebar">
    <div class="roomBox">
      <button onclick="createRoom()">T·∫°o ph√≤ng</button>
      <input id="roomId" placeholder="Nh·∫≠p Room ID"/>
      <button onclick="joinRoom()">Join</button>
    </div>
    <div id="roomInfo"></div>
    <div class="chatBox" id="chat"></div>
    <div class="controls">
      <input id="msg" placeholder="Nh·∫≠p tin nh·∫Øn..."/>
      <button onclick="sendMsg()">G·ª≠i</button>
    </div>
    <button onclick="shareScreen()">üì∫ Share Screen</button>
  </div>
</div>

<script>
let peer, conn, call, myStream;
let isHost = false;

function createRoom(){
  const id = "room-" + Math.random().toString(36).substring(2,8);
  document.getElementById("roomId").value = id;
  document.getElementById("roomInfo").innerHTML = "B·∫°n l√† Host<br>ID ph√≤ng: <b>"+id+"</b>";
  isHost = true;
  startPeer(id);
}

function joinRoom(){
  const id = document.getElementById("roomId").value.trim();
  if(!id) return alert("Nh·∫≠p Room ID");
  document.getElementById("roomInfo").innerHTML = "B·∫°n join ph√≤ng: <b>"+id+"</b>";
  isHost = false;
  startPeer("guest-" + Math.random().toString(36).substring(2,8), id);
}

async function startPeer(myId, connectTo){
  peer = new Peer(myId, { host: 'peerjs.com', secure:true, port:443 });

  peer.on("open", async ()=>{
    console.log("Peer ready:", myId);
    myStream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});

    if(isHost){
      peer.on("connection", c=>{
        conn = c;
        conn.on("data", d=> logChat(d, "peer"));
      });
      peer.on("call", c=>{
        c.answer(myStream);
        c.on("stream", s=> document.getElementById("remoteVideo").srcObject = s);
      });
    } else {
      conn = peer.connect(connectTo);
      conn.on("data", d=> logChat(d, "peer"));
      call = peer.call(connectTo, myStream);
      call.on("stream", s=> document.getElementById("remoteVideo").srcObject = s);
    }
  });
}

function sendMsg(){
  const msg = document.getElementById("msg").value;
  if(conn && conn.open){
    conn.send(msg);
    logChat(msg, "me");
  }
  document.getElementById("msg").value="";
}

function logChat(msg, who){
  let div=document.createElement("div");
  div.className="msg "+who;
  div.textContent=(who==="me"?"B·∫°n: ":"Ng∆∞·ªùi kia: ")+msg;
  document.getElementById("chat").appendChild(div);
  document.getElementById("chat").scrollTop = document.getElementById("chat").scrollHeight;
}

async function shareScreen(){
  let screen = await navigator.mediaDevices.getDisplayMedia({video:true});
  if(call){
    let sender = call.peerConnection.getSenders().find(s=>s.track.kind==="video");
    sender.replaceTrack(screen.getTracks()[0]);
  }
}
</script>
</body>
</html>
