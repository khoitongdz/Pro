<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Cloud Room Demo</title>
  <style>
    body { margin:0; display:flex; height:100vh; background:#111; color:white; font-family:sans-serif; }
    #videoContainer { flex:3; display:flex; justify-content:center; align-items:center; background:#000; }
    video { width:100%; height:100%; object-fit:cover; }
    #sidebar { flex:1; background:#1c1c1c; display:flex; flex-direction:column; }
    #chat { flex:1; overflow-y:auto; padding:10px; }
    #inputBox { display:flex; }
    #inputBox input { flex:1; padding:8px; }
    #inputBox button { padding:8px; }
  </style>
</head>
<body>
  <div id="videoContainer">
    <video id="remoteVideo" autoplay playsinline></video>
  </div>
  <div id="sidebar">
    <h3>Room</h3>
    <input id="roomId" placeholder="Nhập Room ID"/>
    <button onclick="joinRoom()">Join</button>
    <button onclick="shareScreen()">Share Screen</button>
    <div id="chat"></div>
    <div id="inputBox">
      <input id="msg" placeholder="Chat..."/>
      <button onclick="sendMsg()">Gửi</button>
    </div>
  </div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
<script>
// TODO: Dán firebaseConfig của bạn vào đây
const firebaseConfig = {
  apiKey: "xxx",
  authDomain: "xxx",
  databaseURL: "xxx",
  projectId: "xxx",
  storageBucket: "xxx",
  messagingSenderId: "xxx",
  appId: "xxx"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let pc, dc, roomRef;
const servers = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

function logChat(msg, who="system") {
  let div = document.createElement("div");
  div.textContent = who + ": " + msg;
  document.getElementById("chat").appendChild(div);
}

async function joinRoom(){
  const roomId = document.getElementById("roomId").value;
  if(!roomId) return alert("Nhập Room ID");
  roomRef = db.ref("rooms/" + roomId);

  pc = new RTCPeerConnection(servers);
  dc = pc.createDataChannel("chat");
  dc.onmessage = e => logChat(e.data, "peer");

  pc.ondatachannel = e => {
    e.channel.onmessage = ev => logChat(ev.data, "peer");
  };

  pc.ontrack = e => {
    document.getElementById("remoteVideo").srcObject = e.streams[0];
  };

  let stream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
  stream.getTracks().forEach(track => pc.addTrack(track, stream));

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  let snap = await roomRef.once("value");
  if(!snap.exists()){
    await roomRef.set({ offer: offer });
    pc.onicecandidate = e => {
      if(e.candidate) roomRef.child("callerCandidates").push(e.candidate.toJSON());
    };
    roomRef.child("answer").on("value", async s=>{
      if(s.exists()) await pc.setRemoteDescription(s.val());
    });
    roomRef.child("calleeCandidates").on("child_added", async s=>{
      await pc.addIceCandidate(new RTCIceCandidate(s.val()));
    });
  } else {
    let data = snap.val();
    await pc.setRemoteDescription(data.offer);
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    await roomRef.child("answer").set(answer);
    pc.onicecandidate = e=>{
      if(e.candidate) roomRef.child("calleeCandidates").push(e.candidate.toJSON());
    };
    roomRef.child("callerCandidates").on("child_added", async s=>{
      await pc.addIceCandidate(new RTCIceCandidate(s.val()));
    });
  }
}

function sendMsg(){
  const msg = document.getElementById("msg").value;
  if(dc && dc.readyState==="open"){
    dc.send(msg);
    logChat(msg, "me");
  }
  document.getElementById("msg").value="";
}

async function shareScreen(){
  let stream = await navigator.mediaDevices.getDisplayMedia({ video:true });
  stream.getTracks().forEach(track=>{
    pc.getSenders()[0].replaceTrack(track);
  });
}
</script>
</body>
</html>
