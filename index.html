<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Cloud Room Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Cloud Room Pro - Giải pháp họp trực tuyến, gọi video nhóm, chat và chia sẻ màn hình nhanh chóng, bảo mật.">
  <meta name="keywords" content="cloud room, video call, chat trực tuyến, họp online, chia sẻ màn hình, peerjs">
  <meta name="author" content="Cloud Room Pro">

  <!-- Open Graph -->
  <meta property="og:title" content="Cloud Room Pro - Họp trực tuyến thông minh">
  <meta property="og:description" content="Tạo phòng họp, gọi video, chat và chia sẻ màn hình chỉ trong vài giây.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://yourdomain.com">
  <meta property="og:image" content="https://yourdomain.com/thumbnail.png">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Cloud Room Pro - Họp trực tuyến thông minh">
  <meta name="twitter:description" content="Gọi video, chat, chia sẻ màn hình dễ dàng và bảo mật.">
  <meta name="twitter:image" content="https://yourdomain.com/thumbnail.png">

  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <style>
    body{margin:0;font-family:Segoe UI, sans-serif;background:#0f172a;color:#fff;display:flex;flex-direction:column;height:100vh;}
    header{padding:12px;text-align:center;background:#1e293b;}
    .main{flex:1;display:flex;gap:12px;padding:12px;}
    .videos{flex:3;display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:10px;background:#000;border-radius:12px;padding:10px;overflow:auto;}
    video{width:100%;height:200px;object-fit:cover;border-radius:12px;background:#111;}
    .sidebar{flex:1;background:#1e293b;border-radius:12px;display:flex;flex-direction:column;padding:12px;}
    .roomBox{margin-bottom:12px;display:flex;gap:6px;}
    input,button{padding:8px;border:none;border-radius:8px;font-size:14px;}
    input{flex:1;}
    button{background:linear-gradient(135deg,#3b82f6,#06b6d4);color:#fff;cursor:pointer;font-weight:600;transition:.2s;}
    button:hover{opacity:.85;}
    .chatBox{flex:1;background:#0f172a;border-radius:8px;padding:6px;overflow-y:auto;margin:6px 0;}
    .msg{margin:4px 0;}
    .me{color:#3b82f6;}
    .peer{color:#06b6d4;}
    .controls{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px;}
    #qrcode{margin-top:10px;}
    .userList{background:#0f172a;border-radius:8px;padding:6px;max-height:120px;overflow-y:auto;margin:6px 0;font-size:14px;}
    .userList div{padding:4px 0;border-bottom:1px solid #1e293b;display:flex;justify-content:space-between;align-items:center;}
    .spotlight video{width:100%!important;height:400px!important;}
  </style>
</head>
<body>
<header><h2>📱 Cloud Room Pro</h2></header>
<div class="main">
  <div class="videos" id="videos"></div>
  <div class="sidebar">
    <div class="roomBox">
      <button onclick="createRoom()">Tạo phòng</button>
      <input id="roomId" placeholder="Nhập Room ID"/>
      <button onclick="joinRoom()">Join</button>
    </div>
    <div id="roomInfo"></div>
    <canvas id="qrcode"></canvas>
    <div class="userList" id="users"></div>
    <div class="chatBox" id="chat"></div>
    <div class="controls">
      <input id="msg" placeholder="Tin nhắn..."/>
      <button onclick="sendMsg()">💬 Gửi</button>
      <button onclick="toggleMic()">🎤 Mic</button>
      <button onclick="toggleCam()">📷 Cam</button>
      <button onclick="shareScreen()">📺 Share</button>
      <button onclick="toggleLayout()">🖼 Layout</button>
    </div>
  </div>
</div>

<script>
let peer,myStream,roomId,myId,isHost=false;
let peers={},conns={},usersList={},micOn=true,camOn=true,layout="grid";

function createRoom(){
  roomId="room-"+Math.random().toString(36).substr(2,6);
  isHost=true;
  document.getElementById("roomId").value=roomId;
  document.getElementById("roomInfo").innerHTML="Phòng: <b>"+roomId+"</b> (Chủ phòng)";
  QRCode.toCanvas(document.getElementById("qrcode"),window.location.href+"#"+roomId);
  startPeer();
}
function joinRoom(){
  roomId=document.getElementById("roomId").value.trim();
  if(!roomId) return alert("Nhập Room ID");
  document.getElementById("roomInfo").innerHTML="Join phòng: <b>"+roomId+"</b>";
  QRCode.toCanvas(document.getElementById("qrcode"),window.location.href+"#"+roomId);
  startPeer();
}
async function startPeer(){
  myId="user-"+Math.random().toString(36).substr(2,6);
  peer=new Peer(myId,{host:'peerjs.com',secure:true,port:443});

  peer.on("open", async ()=>{
    myStream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
    addVideo(myStream,myId,true);
    addUser(myId);
  });

  peer.on("connection",c=>{
    c.on("data",d=>{
      if(d.type==="chat") logChat(d.msg,"peer");
      if(d.type==="join") addUser(d.id);
      if(d.type==="leave") removeUser(d.id);
      if(d.type==="hostCmd" && isHost) handleHostCmd(d);
    });
  });

  peer.on("call",c=>{
    c.answer(myStream);
    c.on("stream",s=>addVideo(s,c.peer));
    addUser(c.peer);
  });
}
function connectTo(id){
  if(conns[id]) return;
  conns[id]=peer.connect(id);
  conns[id].on("open",()=>{conns[id].send({type:"join",id:myId});});
  conns[id].on("data",d=>{
    if(d.type==="chat") logChat(d.msg,"peer");
    if(d.type==="join") addUser(d.id);
    if(d.type==="leave") removeUser(d.id);
    if(d.type==="hostCmd") handleHostCmd(d);
  });

  let call=peer.call(id,myStream);
  call.on("stream",s=>addVideo(s,id));
  peers[id]=call;
  addUser(id);
}
function sendMsg(){
  let msg=document.getElementById("msg").value;
  if(!msg) return;
  logChat(msg,"me");
  for(let id in conns){ if(conns[id].open) conns[id].send({type:"chat",msg}); }
  document.getElementById("msg").value="";
}
function logChat(msg,who){
  let div=document.createElement("div");
  div.className="msg "+who;
  div.textContent=(who==="me"?"Bạn: ":"Người khác: ")+msg;
  document.getElementById("chat").appendChild(div);
  document.getElementById("chat").scrollTop=document.getElementById("chat").scrollHeight;
}
function addVideo(stream,id,self=false){
  if(document.getElementById("v-"+id)) return;
  let video=document.createElement("video");
  video.srcObject=stream;
  video.autoplay=true;video.playsInline=true;
  if(self) video.muted=true;
  video.id="v-"+id;
  document.getElementById("videos").appendChild(video);
}
function toggleMic(){
  micOn=!micOn;
  myStream.getAudioTracks()[0].enabled=micOn;
  alert("Mic "+(micOn?"bật":"tắt"));
}
function toggleCam(){
  camOn=!camOn;
  myStream.getVideoTracks()[0].enabled=camOn;
  alert("Camera "+(camOn?"bật":"tắt"));
}
async function shareScreen(){
  let screen=await navigator.mediaDevices.getDisplayMedia({video:true});
  for(let id in peers){
    let sender=peers[id].peerConnection.getSenders().find(s=>s.track.kind==="video");
    if(sender) sender.replaceTrack(screen.getTracks()[0]);
  }
}
function addUser(id){
  if(usersList[id]) return;
  usersList[id]=true;
  updateUsers();
}
function removeUser(id){
  delete usersList[id];
  if(document.getElementById("v-"+id)) document.getElementById("v-"+id).remove();
  updateUsers();
}
function updateUsers(){
  let box=document.getElementById("users");
  box.innerHTML="<b>👥 Thành viên:</b><br>";
  Object.keys(usersList).forEach(id=>{
    let row=document.createElement("div");
    row.innerHTML="• "+id;
    if(isHost && id!==myId){
      let controls=document.createElement("span");
      controls.innerHTML=` <button onclick="sendHostCmd('${id}','mute')">🔇</button> <button onclick="sendHostCmd('${id}','cam')">📵</button>`;
      row.appendChild(controls);
    }
    box.appendChild(row);
  });
}
function toggleLayout(){
  let videos=document.getElementById("videos");
  if(layout==="grid"){layout="spotlight";videos.classList.add("spotlight");}
  else{layout="grid";videos.classList.remove("spotlight");}
}
function sendHostCmd(target,cmd){
  if(conns[target]&&conns[target].open){
    conns[target].send({type:"hostCmd",cmd});
  }
}
function handleHostCmd(d){
  if(d.cmd==="mute"){myStream.getAudioTracks()[0].enabled=false;alert("Chủ phòng tắt mic của bạn");}
  if(d.cmd==="cam"){myStream.getVideoTracks()[0].enabled=false;alert("Chủ phòng tắt camera của bạn");}
}
window.onbeforeunload=()=>{for(let id in conns){conns[id].send({type:"leave",id:myId});}};
</script>
</body>
</html>
